{"version":3,"sources":["../../src/util/cli_scan.js"],"names":["Promise","require","fs","promisifyAll","glob","promisify","path","ignore","i18nc","debug","exports","dir","filelist","subdirConfigs","ignoreConfigs","map","file","dirname","configfile","configPo","_checkAndLoadConfig","ignorefile","ignorePo","_checkAndLoadIgnore","all","arr","ignores","config","concurrency","results","filter","val","statAsync","stats","isFile","loadConfig","readFileAsync","buf","ig","hasIg","toString","split","forEach","trim","add","mainConfig","extConfigs","extends","Array","isArray","length","unshift","extend","reduce","a","b"],"mappings":"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","sourcesContent":["'use strict';\n\nconst Promise = require('bluebird');\nconst fs = Promise.promisifyAll(require('fs'));\nconst glob = Promise.promisify(require('glob'));\nconst path = require('path');\nconst ignore = require('ignore');\nconst i18nc = require('i18nc');\nconst debug = require('debug')('i18nc:cli_scan');\n\nexports.dir = async function(dir)\n{\n\tlet filelist = await glob(dir, {});\n\tlet subdirConfigs = {};\n\tlet ignoreConfigs = {};\n\n\tlet results = await Promise.map(filelist, async function(file)\n\t\t{\n\t\t\tlet dirname = path.dirname(file);\n\n\t\t\tlet configfile = dirname + '/' + '.i18ncrc.js';\n\t\t\tlet configPo = subdirConfigs[configfile]\n\t\t\t\t|| (subdirConfigs[configfile] = _checkAndLoadConfig(configfile));\n\n\t\t\tlet ignorefile = dirname + '/' + '.i18ncignore';\n\t\t\tlet ignorePo = ignoreConfigs[ignorefile]\n\t\t\t\t|| (ignoreConfigs[ignorefile] = _checkAndLoadIgnore(ignorefile));\n\n\t\t\tlet arr = await Promise.all([configPo, ignorePo]);\n\n\t\t\tif (arr[1] && arr[1].ignores(file))\n\t\t\t{\n\t\t\t\tdebug('ignore file: %s', file);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\treturn {file, config: arr[0]};\n\t\t},\n\t\t{\n\t\t\tconcurrency: 5\n\t\t});\n\n\treturn results.filter(function(val)\n\t\t{\n\t\t\treturn val;\n\t\t});\n}\n\nexports.file = async function(file)\n{\n\tlet dirname = path.dirname(file);\n\tlet configfile = dirname + '/' + '.i18ncrc.js';\n\tlet config = await _checkAndLoadConfig(configfile);\n\treturn {file, config};\n}\n\nasync function _checkAndLoadConfig(file)\n{\n\ttry {\n\t\tlet stats = await fs.statAsync(file);\n\t\tif (!stats.isFile())\n\t\t{\n\t\t\tdebug('configfile is not file: %s', file);\n\t\t\tfile = null;\n\t\t}\n\t}\n\tcatch(err)\n\t{\n\t\tdebug('get configfile is err:%o', err);\n\t\tfile = null;\n\t}\n\n\tif (file)\n\t{\n\t\tlet config = await loadConfig(file);\n\t\treturn config;\n\t}\n}\n\nasync function _checkAndLoadIgnore(file)\n{\n\ttry {\n\t\tlet stats = await fs.statAsync(file);\n\t\tif (!stats.isFile())\n\t\t{\n\t\t\tdebug('ignore is not file: %s', file);\n\t\t\tfile = null;\n\t\t}\n\t}\n\tcatch(err)\n\t{\n\t\tdebug('get ignore is err:%o', err);\n\t\tfile = null;\n\t}\n\n\tif (file)\n\t{\n\t\tlet buf = await fs.readFileAsync(file);\n\t\tlet ig = new ignore();\n\t\tlet hasIg = false;\n\t\tbuf.toString().split(/\\n/g).forEach(function(file)\n\t\t{\n\t\t\tfile = file.trim();\n\t\t\tif (file)\n\t\t\t{\n\t\t\t\thasIg = true;\n\t\t\t\tig.add(file);\n\t\t\t}\n\t\t});\n\n\t\tif (hasIg) return ig;\n\t}\n}\n\n\nexports.loadConfig = loadConfig;\nasync function loadConfig(file)\n{\n\tlet mainConfig = require(file);\n\tlet extConfigs = mainConfig.extends;\n\tif (extConfigs)\n\t{\n\t\tlet dirname = path.dirname(file);\n\t\textConfigs = Array.isArray(extConfigs) ? extConfigs : [extConfigs];\n\t\tif (extConfigs.length)\n\t\t{\n\t\t\textConfigs.unshift(i18nc.extend(mainConfig));\n\t\t\tmainConfig = extConfigs.reduce(function(a, b)\n\t\t\t{\n\t\t\t\treturn i18nc.extend(loadConfig(dirname + '/' + b), a);\n\t\t\t});\n\t\t}\n\t}\n\n\treturn mainConfig;\n}\n"],"file":"cli_scan.js"}