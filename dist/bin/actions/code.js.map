{"version":3,"sources":["../../../src/bin/actions/code.js"],"names":["Promise","require","debug","fs","promisifyAll","mkdirp","promisify","path","extend","cliUtil","i18ncUtil","module","exports","code","input","output","options","translateDBFile","readTranslateDBFilePromise","resolve","readFileAsync","encoding","then","data","JSON","parse","allfiledata","all","scanFileList","isRecurse","inputPOFile","loadPOFile","inputPODir","autoLoadPOFiles","fileInfo","dbTranslateWords","myOptions","I18NHandlerName","I18NHandlerAlias","ignoreScanHandlerNames","codeModifyItems","I18NHandler","onlyTheseLanguages","style","minFuncCode","minTranslateFuncCode","upgrade","partial","isPartialUpdate","insert","checkClosure","isCheckClosureForNewI18NHandler","type","map","file","file2i18nc","isOnlyCheck","wfile","writeFile","console","log","concurrency","getWriteOneFilePath","writeFileAsync","outputWordFile","writeOutputWordFilePromise","stringify","outputPODir","mulitResult2POFiles","pickFileLanguages","content","dirname"],"mappings":"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","sourcesContent":["'use strict';\n\nconst Promise   = require('bluebird');\nconst debug     = require('debug')('i18nc');\nconst fs        = Promise.promisifyAll(require('fs'));\nconst mkdirp    = Promise.promisify(require('mkdirp'));\nconst path      = require('path');\nconst extend    = require('extend');\nconst cliUtil   = require('../cli_util');\nconst i18ncUtil = require('../../util/index');\n\n\nmodule.exports = function code(input, output, options)\n{\n\tlet translateDBFile = options.translateDBFile;\n\tlet readTranslateDBFilePromise;\n\n\tif (translateDBFile)\n\t{\n\t\ttranslateDBFile = path.resolve(translateDBFile);\n\t\tdebug('read translateDBFile:%s', translateDBFile);\n\n\t\treadTranslateDBFilePromise = fs.readFileAsync(translateDBFile,\n\t\t\t{\n\t\t\t\tencoding: 'utf8'\n\t\t\t})\n\t\t\t.then(function(data)\n\t\t\t{\n\t\t\t\treturn JSON.parse(data);\n\t\t\t});\n\t}\n\n\tlet allfiledata = {};\n\n\treturn Promise.all(\n\t\t[\n\t\t\tcliUtil.scanFileList(path.resolve(input), null, options.isRecurse),\n\t\t\treadTranslateDBFilePromise,\n\t\t\toptions.inputPOFile && i18ncUtil.loadPOFile(path.resolve(options.inputPOFile)),\n\t\t\toptions.inputPODir && i18ncUtil.autoLoadPOFiles(path.resolve(options.inputPODir))\n\t\t])\n\t\t.then(function(data)\n\t\t{\n\t\t\tlet fileInfo = data[0];\n\t\t\tlet dbTranslateWords = extend(true, {}, data[2], data[3], data[1]);\n\t\t\tlet myOptions =\n\t\t\t{\n\t\t\t\tdbTranslateWords       : dbTranslateWords,\n\t\t\t\tI18NHandlerName        : options.I18NHandlerName,\n\t\t\t\tI18NHandlerAlias       : options.I18NHandlerAlias,\n\t\t\t\tignoreScanHandlerNames : options.ignoreScanHandlerNames,\n\t\t\t\tcodeModifyItems        : options.codeModifyItems,\n\t\t\t\tI18NHandler:\n\t\t\t\t{\n\t\t\t\t\tdata: {onlyTheseLanguages: options.onlyTheseLanguages},\n\t\t\t\t\tstyle: {minFuncCode: options.minTranslateFuncCode},\n\t\t\t\t\tupgrade: {partial: options.isPartialUpdate},\n\t\t\t\t\tinsert:\n\t\t\t\t\t{\n\t\t\t\t\t\tcheckClosure: options.isCheckClosureForNewI18NHandler,\n\t\t\t\t\t},\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif (fileInfo.type == 'list')\n\t\t\t{\n\t\t\t\treturn Promise.map(fileInfo.data, function(file)\n\t\t\t\t\t{\n\t\t\t\t\t\tdebug('i18n file start: %s', file);\n\n\t\t\t\t\t\treturn cliUtil.file2i18nc(file, myOptions)\n\t\t\t\t\t\t\t.then(function(data)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlet code = data.code;\n\t\t\t\t\t\t\t\tdelete data.code;\n\t\t\t\t\t\t\t\tallfiledata[file] = data;\n\t\t\t\t\t\t\t\tif (options.isOnlyCheck) return;\n\n\t\t\t\t\t\t\t\tlet wfile = path.resolve(output, file);\n\t\t\t\t\t\t\t\tdebug('writefile: %s', wfile);\n\n\t\t\t\t\t\t\t\treturn writeFile(wfile, code)\n\t\t\t\t\t\t\t\t\t.then(function()\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tconsole.log('write file: '+wfile);\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tconcurrency: 5\n\t\t\t\t\t});\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tlet file = fileInfo.data;\n\t\t\t\tdebug('one file mod:%s', file);\n\n\t\t\t\treturn cliUtil.file2i18nc(file, myOptions)\n\t\t\t\t\t.then(function(data)\n\t\t\t\t\t{\n\t\t\t\t\t\tlet code = data.code;\n\t\t\t\t\t\tdelete data.code;\n\n\t\t\t\t\t\tallfiledata[file] = data;\n\t\t\t\t\t\tif (options.isOnlyCheck) return;\n\n\t\t\t\t\t\tlet wfile = path.resolve(output);\n\t\t\t\t\t\tdebug('writefile: %s', wfile);\n\n\t\t\t\t\t\treturn cliUtil.getWriteOneFilePath(wfile, file)\n\t\t\t\t\t\t\t.then(function(wfile)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn fs.writeFileAsync(wfile, code)\n\t\t\t\t\t\t\t\t\t.then(function()\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tconsole.log('write file: '+wfile);\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t}\n\t\t})\n\t\t.then(function()\n\t\t{\n\t\t\t// 如果仅仅检查，则不处理写的逻辑\n\t\t\tif (options.isOnlyCheck) return;\n\n\t\t\tlet outputWordFile = options.outputWordFile;\n\t\t\tlet writeOutputWordFilePromise;\n\t\t\tif (outputWordFile)\n\t\t\t{\n\t\t\t\toutputWordFile = path.resolve(outputWordFile);\n\t\t\t\twriteOutputWordFilePromise = writeFile(outputWordFile, JSON.stringify(allfiledata, null, '\\t'))\n\t\t\t\t\t.then(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tconsole.log('write words file: '+outputWordFile);\n\t\t\t\t\t});\n\t\t\t}\n\n\t\t\tlet outputPODir = options.outputPODir;\n\t\t\tif (outputPODir) outputPODir = path.resolve(outputPODir);\n\n\t\t\treturn Promise.all(\n\t\t\t\t[\n\t\t\t\t\twriteOutputWordFilePromise,\n\t\t\t\t\toutputPODir && i18ncUtil.mulitResult2POFiles(allfiledata, outputPODir,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tpickFileLanguages: options.pickFileLanguages\n\t\t\t\t\t\t})\n\t\t\t\t])\n\t\t\t\t.then(function(){});\n\t\t});\n}\n\n\nfunction writeFile(file, content)\n{\n\treturn mkdirp(path.dirname(file))\n\t\t.then(function()\n\t\t{\n\t\t\treturn fs.writeFileAsync(file, content);\n\t\t});\n}\n"],"file":"code.js"}